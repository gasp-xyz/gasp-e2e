name: GASP UI Playwright Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "30 7 * * *"

jobs:
  playwright-tests:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    env:
      UI_URL: https://app.gasp.xyz
      LMNR_PROJECT_API_KEY: ${{ secrets.LMNR_PROJECT_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd fe-ai-tests
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          
      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium
          
      - name: Create directories for test artifacts
        run: |
          mkdir -p fe-ai-tests/tmp/record_videos
          
      - name: Run Playwright tests
        run: |
          cd fe-ai-tests
          pytest agent_gasp1_optimised_nowarn_test.py -v
          
      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: fe-ai-tests/tmp/record_videos
          retention-days: 7
          
  slack-notify:
    needs: [playwright-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Slack Notification - Success
        if: ${{ needs.playwright-tests.result == 'success' }}
        uses: bryannice/gitactions-slack-notification@2.0.0
        env:
          SLACK_INCOMING_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "GASP UI Playwright Tests - Success"
          SLACK_COLOR: "#00ff11"
          SLACK_MESSAGE: "Playwright tests passed successfully!"
          
      - name: Slack Notification - Failure
        if: ${{ needs.playwright-tests.result == 'failure' }}
        uses: bryannice/gitactions-slack-notification@2.0.0
        env:
          SLACK_INCOMING_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "GASP UI Playwright Tests - Failure"
          SLACK_COLOR: "#ff0011"
          SLACK_MESSAGE: "Playwright tests failed. Please check the logs for details."